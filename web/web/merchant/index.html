<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Foody ¬∑ –õ–ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</title>
  <link rel="stylesheet" href="./style.css?v=dark2" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
<!-- FilePond CSS -->
<link href="https://unpkg.com/filepond@4.30.7/dist/filepond.min.css" rel="stylesheet">
<link href="https://unpkg.com/filepond-plugin-image-preview@4.6.12/dist/filepond-plugin-image-preview.min.css" rel="stylesheet">
<link href="./offer_photo_filepond.css" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
  <script>window.foodyApi = (window.__FOODY__ && window.__FOODY__.FOODY_API) || window.foodyApi || 'https://foodyback-production.up.railway.app';</script>
  <script defer src="/config.js"></script>
  <script defer src="./app.js?v=no247-1"></script>
  <style>
    #cityModal[aria-hidden="true"] { display: none; }
    #cityModal[aria-hidden="false"] { display: block; }
    #cityModal { position: fixed; inset: 0; z-index: 50; }
    #cityModal .modal-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,.5); backdrop-filter: blur(2px); }
    #cityModal .modal-dialog { position: relative; max-width: 520px; margin: 6vh auto; background: var(--card-bg, #121212); color: var(--fg, #fff); border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.4); overflow: hidden; }
    #cityModal .modal-header { display:flex; align-items:center; justify-content:space-between; padding:16px 18px; font-weight:600; border-bottom: 1px solid rgba(255,255,255,.08); }
    #cityModal .modal-body { padding: 14px 16px 16px; }
    #cityModal .close { background: transparent; border:none; font-size:20px; line-height:1; color: inherit; cursor: pointer; opacity:.8; }
    #cityModal .close:hover { opacity:1; }

    .city-search { width: 100%; padding: 10px 12px; border-radius: 10px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); color: inherit; outline: none; }
    .city-search::placeholder { opacity:.6; }

    .city-grid { margin-top: 12px; display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 8px; }
    @media (min-width: 480px) { .city-grid { grid-template-columns: repeat(3, minmax(0,1fr)); } }
    .city-chip { padding: 10px 12px; border-radius: 12px; text-align:center; cursor:pointer; user-select:none;
      border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); transition: transform .06s ease, background .2s ease, border-color .2s ease; }
    .city-chip:hover { transform: translateY(-1px); background: rgba(255,255,255,.07); border-color: rgba(255,255,255,.2); }
    .city-chip.active { background: rgba(0, 180, 120, .2); border-color: rgba(0, 180, 120, .4); }

    .city-other { margin-top: 12px; display:flex; gap:8px; align-items:center; }
    .city-other input { flex:1; padding: 10px 12px; border-radius: 10px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); color: inherit; }
    .city-other .btn { white-space:nowrap; }

    .city-picker { display:flex; gap:8px; align-items:center; }
    .city-display { flex:1; display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); cursor:pointer; }
    .city-display .hint { opacity:.7; }
    .city-display .value { font-weight:600; }
    .city-display .caret { opacity:.6; }

    .btn { border-radius: 12px; padding: 10px 12px; border: none; cursor: pointer; }
    .btn-primary { background: #00C27A; color:#081A12; font-weight:700; }
    .btn-ghost { background: transparent; color: inherit; border:1px solid rgba(255,255,255,.12); }

    .w-full { width:100%; }

    .pw-field { position: relative; display: flex; align-items: center; }
    .pw-field input[type="password"], .pw-field input[type="text"] { width:100%; padding-right: 42px; }
    .pw-toggle { position: absolute; right: 8px; background: transparent; border: 0; cursor: pointer; font-size: 18px; line-height: 1; opacity: .75; }
    .pw-toggle:hover { opacity: 1; }
    .pw-toggle[aria-pressed="true"] { opacity: 1; }

    .work-presets { grid-column: 1 / -1; display: flex; flex-wrap: wrap; gap: 8px; margin-top: 6px; }
    .work-presets .chip { padding: 8px 10px; border-radius: 12px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); cursor:pointer; user-select:none; }
    .work-presets .chip:hover { background: rgba(255,255,255,.08); }

    .form-error { color: #ff7b7b; font-size: 13px; }
    .hidden { display: none; }
    .muted.small { opacity:.7; font-size:12px; }
    .ok-badge { color:#00C27A; font-weight:600; font-size: 13px; }
  </style>
</head>
<body>
  <div class="app">
    <header class="tg-header">
      <div class="tg-header__left">
        <div class="avatar">üçΩÔ∏è</div>
        <div class="titles">
          <div class="title">Foody</div>
          <div class="subtitle">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</div>
        </div>
      </div>
      <div class="tg-header__right">
        <button id="logoutBtn" class="btn btn-ghost" style="display:none">–í—ã–π—Ç–∏</button>
      </div>
    </header>

    <nav class="segmented" id="tabs">
      <button class="seg-btn active" data-tab="dashboard">–î–∞—à–±–æ—Ä–¥</button>
      <button class="seg-btn" data-tab="offers">–û—Ñ—Ñ–µ—Ä—ã</button>
      <button class="seg-btn" data-tab="create">–°–æ–∑–¥–∞—Ç—å</button>
      <button class="seg-btn" data-tab="profile">–ü—Ä–æ—Ñ–∏–ª—å</button>
      <button class="seg-btn" data-tab="export">–≠–∫—Å–ø–æ—Ä—Ç</button>
    </nav>

    <main class="content">
      <section class="pane active" id="dashboard">
        <div class="card">
          <div class="card-title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</div>
          <p class="muted">–í–æ–π–¥–∏—Ç–µ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ—Ñ—Ñ–µ—Ä—ã –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–æ—Ñ–∏–ª–µ–º.</p>
        </div>
      </section>

     <section class="pane" id="create">
  <div class="card">
    <div class="card-title">–°–æ–∑–¥–∞—Ç—å –æ—Ñ—Ñ–µ—Ä</div>
    <form id="offerForm" class="form grid two">

      <!-- 1) –ù–∞–∑–≤–∞–Ω–∏–µ -->
      <label class="full">–ù–∞–∑–≤–∞–Ω–∏–µ
        <input name="title" placeholder="–ù–∞–ø—Ä., –ù–∞–±–æ—Ä —Å—É—à–∏ ¬´–ó–∞–∫–∞—Ç¬ª" required>
      </label>

      <!-- 2) –¶–µ–Ω–∞ (—Å—Ç–∞—Ä–∞—è / –æ–±—ã—á–Ω–∞—è) -->
      <label>–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞ (–¥–æ —Å–∫–∏–¥–∫–∏)
        <input name="original_price" id="offerOldPrice" type="number" min="0" step="1" placeholder="–ù–∞–ø—Ä., 350" required>
      </label>

      <!-- 3) –°–∫–∏–¥–∫–∞ (—á–∏–ø—Å—ã) -->
      <div class="full">
        <div class="work-presets" id="discountPresets">
          <span class="chip" data-discount="30">-30%</span>
          <span class="chip" data-discount="40">-40%</span>
          <span class="chip" data-discount="50">-50%</span>
          <span class="chip" data-discount="60">-60%</span>
          <span class="chip" data-discount="70">-70%</span>
          <span class="chip" data-discount="80">-80%</span>
          <span class="chip" data-discount="90">-90%</span>
        </div>
      </div>

      <!-- 4) –ù–æ–≤–∞—è —Ü–µ–Ω–∞ (–ø–æ—Å–ª–µ —Å–∫–∏–¥–∫–∏) -->
      <label>–ù–æ–≤–∞—è —Ü–µ–Ω–∞
        <input name="price" id="offerPrice" type="number" min="0" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 190" required>
      </label>

      <!-- 5) –û—Å—Ç–∞—Ç–æ–∫ / –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ -->
      <label>–û—Å—Ç–∞—Ç–æ–∫ / –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ, —à—Ç
        <input name="qty_total" type="number" min="1" step="1" value="1" required>
      </label>

      <!-- –°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç–∞ (–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–µ –ø–æ–ª–µ) -->
      <label class="full">–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç–∞
        <input name="best_before" id="best_before" type="datetime-local">
        <div class="muted small">–ë—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∏ —É—á–∏—Ç—ã–≤–∞—Ç—å—Å—è –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞—Ö.</div>
      </label>

      <!-- –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –æ—Ñ—Ñ–µ—Ä–∞ -->
      <label class="full">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –æ—Ñ—Ñ–µ—Ä–∞
        <input name="expires_at" id="expires_at" placeholder="–°–µ–≥–æ–¥–Ω—è 21:00" required>
      </label>
      <div class="full">
        <div class="work-presets" id="expirePresets">
          <span class="chip" data-action="close" id="expireToClose" style="display:none">–ö –∑–∞–∫—Ä—ã—Ç–∏—é</span>
        </div>
      </div>

      <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
      <label class="full">–ö–∞—Ç–µ–≥–æ—Ä–∏—è
        <select class="nice-select" name="category">
          <option value="ready_meal">–ì–æ—Ç–æ–≤—ã–µ –±–ª—é–¥–∞</option>
          <option value="bakery">–í—ã–ø–µ—á–∫–∞</option>
          <option value="sushi">–°—É—à–∏/—Ä–æ–ª–ª—ã</option>
          <option value="salad">–°–∞–ª–∞—Ç—ã</option>
          <option value="dessert">–î–µ—Å–µ—Ä—Ç—ã</option>
          <option value="other">–î—Ä—É–≥–æ–µ</option>
        </select>
      </label>

      <!-- –§–æ—Ç–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
      <div class="field">
        <label for="offerImage">–§–æ—Ç–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
        <input type="file" id="offerImage" name="offerImage" accept="image/*">
        <input type="hidden" id="offerImageUrl" name="image_url">
        <p class="hint">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è JPG/PNG/WebP –¥–æ 5 –ú–ë</p>
      </div>

      <!-- –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ -->
      <label class="full">
        <textarea name="description" rows="3" placeholder="–ö—Ä–∞—Ç–∫–æ: —Å–æ—Å—Ç–∞–≤, –ø–æ—Ä—Ü–∏–∏ –∏ —Ç.–ø."></textarea>
      </label>

      <div class="full" style="display:flex;gap:8px;align-items:center;justify-content:flex-end;">
        <div id="offerError" class="form-error hidden" style="margin-right:auto"></div>
        <button class="btn btn-primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ñ—Ñ–µ—Ä</button>
      </div>
    </form>
  </div>
</section>


      <section class="pane" id="offers">
        <div class="card">
          <div class="card-title">–ú–æ–∏ –æ—Ñ—Ñ–µ—Ä—ã</div>
          <div id="offerList" class="table">
            <div class="skeleton"></div>
            <div class="skeleton"></div>
          </div>
        </div>
      </section>

      

      <section class="pane" id="profile">
        <div class="card">
          <div class="card-title">–ü—Ä–æ—Ñ–∏–ª—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</div>
          <form id="profileForm" class="form grid two">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ
              <input name="name" placeholder="–ö–∞—Ñ–µ –ü–ª—é—Å">
            </label>
            <label>–¢–µ–ª–µ—Ñ–æ–Ω
              <input name="phone" id="profilePhone" type="tel" inputmode="tel" autocomplete="tel" placeholder="+7 900 000 00 00">
            </label>
            <label class="full">–ì–æ—Ä–æ–¥
              <div class="city-picker">
                <div id="profileCityOpen" class="city-display w-full">
                  <span class="hint">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</span>
                  <span class="value"></span>
                  <span class="caret">‚ñæ</span>
                </div>
                <input type="hidden" name="city" id="profileCityValue">
              </div>
            </label>
            <label class="full">–ê–¥—Ä–µ—Å
              <input name="address" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º">
            </label>
            <label>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã ‚Äî —Å
              <input name="work_from" id="profile_work_from" type="time" placeholder="09:00">
            </label>
            <label>–¥–æ
              <input name="work_to" id="profile_work_to" type="time" placeholder="22:00">
            </label>
            <div class="muted small full">–ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –Ω–æ—á–Ω—ã–µ —Å–º–µ–Ω—ã ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä, <b>20:00‚Äì04:00</b>.</div>
            <div class="work-presets" data-for="profile">
              <span class="chip" data-from="10:00" data-to="22:00">10:00‚Äì22:00</span>
              <span class="chip" data-from="09:00" data-to="21:00">09:00‚Äì21:00</span>
              <span class="chip" data-from="00:00" data-to="23:59">24/7</span>
            </div>
            <div class="full" style="display:flex;gap:8px;align-items:center;justify-content:flex-end;">
              <div id="profileError" class="form-error hidden" style="margin-right:auto"></div>
              <span id="profileSaved" class="ok-badge" style="display:none;margin-right:auto;">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úì</span>
              <button class="btn btn-primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
          </form>
        </div>

        <div class="card">
          <div class="card-title">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</div>
          <form id="pwForm" class="form">
            <label>–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å
              <div class="pw-field">
                <input type="password" id="pwOld" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                <button class="pw-toggle" id="pwOldToggle" type="button" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å" aria-pressed="false">üëÅ</button>
              </div>
            </label>
            <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å
              <div class="pw-field">
                <input type="password" id="pwNew" placeholder="–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤" minlength="6" required>
                <button class="pw-toggle" id="pwNewToggle" type="button" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å" aria-pressed="false">üëÅ</button>
              </div>
            </label>
            <label>–ü–æ–≤—Ç–æ—Ä –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è
              <input type="password" id="pwNew2" placeholder="–ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" minlength="6" required>
            </label>
            <div id="pwError" class="form-error hidden"></div>
            <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end;">
              <span id="pwSaved" class="ok-badge" style="display:none;margin-right:auto;">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úì</span>
              <button class="btn btn-primary" type="submit">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
            </div>
          </form>
        </div>
      </section>

      <section class="pane" id="export">
        <div class="card">
          <div class="card-title">–≠–∫—Å–ø–æ—Ä—Ç CSV</div>
          <p class="muted">–°–∫–∞—á–∞–π—Ç–µ –≤—ã–≥—Ä—É–∑–∫—É —Ç–µ–∫—É—â–∏—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤.</p>
          <button id="downloadCsv" class="btn btn-primary">–°–∫–∞—á–∞—Ç—å CSV</button>
        </div>
        <div class="card">
          <div class="card-title">–¢–µ–∫—É—â–∏–µ –∫–ª—é—á–∏</div>
          <pre id="creds" class="dump small">‚Äî</pre>
          <div class="muted small">–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–ø—Ä–æ—Å–∞–º–∏, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å API.</div>
        </div>
      </section>
    </main>

    <nav class="bottom-nav">
      <button class="nav-btn active" data-tab="dashboard" title="–î–∞—à–±–æ—Ä–¥">üè†</button>
      <button class="nav-btn" data-tab="offers" title="–û—Ñ—Ñ–µ—Ä—ã">üõçÔ∏è</button>
      <button class="nav-btn fab" data-tab="create" title="–°–æ–∑–¥–∞—Ç—å">Ôºã</button>
      <button class="nav-btn" data-tab="profile" title="–ü—Ä–æ—Ñ–∏–ª—å">üë§</button>
      <button class="nav-btn" data-tab="export" title="–≠–∫—Å–ø–æ—Ä—Ç">‚¨áÔ∏è</button>
    </nav>

    <div class="modal" id="cityModal" aria-hidden="true">
      <div class="modal-backdrop" id="cityBackdrop"></div>
      <div class="modal-dialog" role="dialog" aria-modal="true">
        <div class="modal-header">
          –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥
          <button class="close" id="cityClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
        </div>
        <div class="modal-body">
          <input type="text" id="citySearch" class="city-search" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞‚Ä¶">
          <div class="city-grid" id="cityGrid"></div>
          <div class="city-other" id="cityOtherWrap" style="display:none;">
            <input id="cityOtherInput" placeholder="–°–≤–æ–π –≥–æ—Ä–æ–¥">
            <button id="cityOtherApply" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          </div>
        </div>
      </div>
    </div>

    <div id="toast"></div>
  </div>

<!-- CDN FilePond (–µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –≤–≤–µ—Ä—Ö—É ‚Äî –Ω–µ –¥—É–±–ª–∏—Ä—É–π —ç—Ç–∏ —á–µ—Ç—ã—Ä–µ —Å—Ç—Ä–æ–∫–∏) -->
<link href="https://unpkg.com/filepond@4.30.7/dist/filepond.min.css" rel="stylesheet">
<link href="https://unpkg.com/filepond-plugin-image-preview@4.6.12/dist/filepond-plugin-image-preview.min.css" rel="stylesheet">
<script src="https://unpkg.com/filepond@4.30.7/dist/filepond.min.js" defer></script>
<script src="https://unpkg.com/filepond-plugin-image-preview@4.6.12/dist/filepond-plugin-image-preview.min.js" defer></script>
<script src="https://unpkg.com/filepond-plugin-file-validate-type@1.2.8/dist/filepond-plugin-file-validate-type.min.js" defer></script>
<script src="https://unpkg.com/filepond-plugin-file-validate-size@2.2.8/dist/filepond-plugin-file-validate-size.min.js" defer></script>

<style id="foody-inline-photo">
/* FilePond –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ) */
.filepond--root{border-radius:14px;background:rgba(255,255,255,.03);border:1px dashed rgba(255,255,255,.18)}
.filepond--root:focus-within{border-color:rgba(0,194,122,.6);box-shadow:0 0 0 4px rgba(0,194,122,.15)}
.filepond--drop-label{font-size:14px;opacity:.85}
.filepond--credits{display:none!important}
/* –ö—Ä–∞—Å–∏–≤—ã–π —Å–µ–ª–µ–∫—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–µ—Å–ª–∏ –≤ style.css –Ω–µ—Ç) */
select.nice-select{
  -webkit-appearance:none; -moz-appearance:none; appearance:none;
  width:100%; padding:10px 40px 10px 12px;
  border-radius:12px; border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04) right 12px center / 12px no-repeat;
  color:inherit; outline:none; cursor:pointer;
  background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8' fill='none'><path d='M1 1.5L6 6.5L11 1.5' stroke='%23CCCCCC' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/></svg>");
}
select.nice-select:focus{ border-color: rgba(0,194,122,.5); box-shadow: 0 0 0 3px rgba(0,194,122,.15); }
</style>

<script id="foody-inline-js">
/*! inline-mini3 ‚Äî FilePond + –≤–∞–ª–∏–¥–∞—Ü–∏—è/—Å–≤—è–∑–∫–∞ —Å–∫–∏–¥–∫–∏ (–±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö —Ñ–∞–π–ª–æ–≤) */
(function(){
  window.__FOODY_ENH_VERSION = 'inline-mini3';
  const ready = (fn)=>{ if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', fn); else fn(); };

  ready(function(){
    initPhoto();
    initValidation();
  });

  function initPhoto(){
    const field = document.querySelector('#create #offerForm .field, #create form .field');
    const input = document.getElementById('offerImage');
    const hidden= document.getElementById('offerImageUrl');
    if (!field || !input || !hidden) return;

    // –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É
    let hint = field.querySelector('.hint');
    const setHint=(msg,kind)=>{
      if(!hint){
        hint = document.createElement('p'); hint.className='hint'; field.appendChild(hint);
      }
      hint.textContent = msg || '';
      hint.style.color = kind==='ok' ? '#00C27A' : (kind==='err' ? '#ff7b7b' : '');
      hint.style.fontWeight = kind ? '600' : '';
    };

    if (typeof FilePond === 'undefined'){ setHint('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è JPG/PNG/WebP –¥–æ 5 –ú–ë'); return; }

    try{
      if (typeof FilePondPluginImagePreview!=='undefined') FilePond.registerPlugin(FilePondPluginImagePreview);
      if (typeof FilePondPluginFileValidateType!=='undefined') FilePond.registerPlugin(FilePondPluginFileValidateType);
      if (typeof FilePondPluginFileValidateSize!=='undefined') FilePond.registerPlugin(FilePondPluginFileValidateSize);
    }catch(_){}

    if (input._pondInit) return;
    input._pondInit = true;

    const files = hidden.value ? [{source:hidden.value, options:{type:'local'}}] : [];
    const pond = FilePond.create(input, {
      credits:false, allowMultiple:false, maxFiles:1, files,
      acceptedFileTypes:['image/*'], allowImagePreview:true,
      imagePreviewHeight:180, stylePanelAspectRatio:'1:1',
      maxFileSize:'5MB',
      labelIdle:'–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ <span class="filepond--label-action">–≤—ã–±–µ—Ä–∏—Ç–µ</span>'
    });

    if (hidden.value) setHint('–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ‚úì','ok'); else setHint('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è JPG/PNG/WebP –¥–æ 5 –ú–ë');

    pond.on('addfile', async (err, item)=>{
      if (err){ setHint('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª','err'); return; }
      try{
        setHint('–ó–∞–≥—Ä—É–∂–∞–µ–º‚Ä¶');
        if (typeof window.uploadImage === 'function'){
          const url = await window.uploadImage(item.file);
          hidden.value = url || '';
        }
        setHint(hidden.value ? '–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ‚úì' : '–§–∞–π–ª –≤—ã–±—Ä–∞–Ω. –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.','ok');
      }catch(e){ console.error(e); hidden.value=''; setHint('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ','err'); }
    });
    pond.on('removefile', ()=>{ hidden.value=''; setHint('–§–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ','err'); });
  }

  function initValidation(){
    const form  = document.querySelector('#create #offerForm, #create form');
    if (!form) return;

    const base  = form.querySelector('#offerOldPrice,[name="original_price"]');
    const final = form.querySelector('#offerPrice,[name="price"]');
    const qty   = form.querySelector('[name="qty_total"]');
    const ex    = form.querySelector('#expires_at,[name="expires_at"]');
    const bb    = form.querySelector('#best_before,#bestBefore');
    const err   = form.querySelector('#offerError');
    const chips = Array.from(form.querySelectorAll('#discountPresets .chip'));

    // —É–¥–∞–ª–∏—Ç—å —Å–ª—É—á–∞–π–Ω—ã–µ +1/+2 (–µ—Å–ª–∏ –∫–æ–≥–¥–∞-—Ç–æ –ø–æ–¥—Å—É–Ω–µ—Ç)
    const expWrap = form.querySelector('#expirePresets');
    if (expWrap){
      expWrap.querySelectorAll('.chip').forEach(ch=>{
        if (ch.dataset.exp && /^\+\d+$/.test(ch.dataset.exp)) ch.remove();
      });
    }

    // —Ä–µ–∑—é–º–µ
    let summary = document.getElementById('foodySummary');
    if (!summary){ summary = document.createElement('div'); summary.id='foodySummary'; summary.className='muted'; summary.style.marginTop='6px'; summary.style.fontWeight='600'; form.appendChild(summary); }

    const money = v => { if(v==null) return NaN; const s=String(v).replace(/\s+/g,'').replace(',','.').replace(/[^\d.]/g,''); return parseFloat(s); };
    const clamp = (n,min,max)=> Math.min(max, Math.max(min,n));
    const parseDate = val => { if(!val) return null; if(/^\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}$/.test(val)) return new Date(val.replace(' ','T')); if(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/.test(val)) return new Date(val); const d=new Date(val); return isNaN(d)?null:d; };
    const markChip = (d)=> chips.forEach(x=> x.classList.toggle('active', parseInt(x.dataset.discount,10)===parseInt(d,10)));

    function recalcFromDiscount(dVal){
      if (!base || !final) return;
      const b = money(base.value);
      const d = dVal!=null ? parseInt(dVal,10) : NaN; // –ø–æ–ª—è "–°–∫–∏–¥–∫–∞,%" —É –Ω–∞—Å –Ω–µ—Ç ‚Äî –±–µ—Ä—ë–º –∏–∑ —á–∏–ø—Å–∞
      if (isFinite(b) && isFinite(d)){
        final.value = String(Math.round(b * (1 - clamp(d,0,99)/100)));
      }
      markChip(d);
      updateSummary();
    }
    function recalcFromFinal(){
      // –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª—è "–°–∫–∏–¥–∫–∞,%", –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑—é–º–µ
      updateSummary();
    }
    function updateSummary(){
      const b = money(base && base.value), f = money(final && final.value), q = parseInt(qty && qty.value || '0',10) || 0;
      const d = (isFinite(b)&&isFinite(f)&&b>0)? Math.round((1 - f/b)*100) : null;
      if (isFinite(f) && q>0){
        const total = Math.round(f)*q;
        summary.textContent = `–ò—Ç–æ–≥: ${Math.round(f)} ‚ÇΩ √ó ${q} —à—Ç = ${total} ‚ÇΩ` + (d!=null?` (—Å–∫–∏–¥–∫–∞ ${d}%)`:``);
      } else { summary.textContent = ''; }
    }

    chips.forEach(ch=> !ch._bound && (ch._bound=true, ch.addEventListener('click', e=>{
      e.preventDefault();
      const d=parseInt(ch.dataset.discount,10);
      if(!isFinite(d)) return;
      recalcFromDiscount(d);
    })));

    if (base && !base._bound){ base.addEventListener('input', recalcFromFinal); base.addEventListener('change', recalcFromFinal); base._bound=true; }
    if (final && !final._bound){ final.addEventListener('input', recalcFromFinal); final.addEventListener('change', recalcFromFinal); final._bound=true; }
    if (qty && !qty._bound){ qty.addEventListener('input', updateSummary); qty._bound=true; }

    // –ø–µ—Ä–≤–∏—á–Ω—ã–π –ø–µ—Ä–µ—Å—á—ë—Ç (–µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É—Ç —á–∏–ø ‚Äî –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç, –∏–Ω–∞—á–µ —Ç–æ–ª—å–∫–æ —Ä–µ–∑—é–º–µ)
    updateSummary();

    // –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —Å–∞–±–º–∏—Ç–µ (–∫–æ—Ä–æ—Ç–∫–∞—è)
    form.addEventListener('submit', (e)=>{
      if (err) err.classList.add('hidden');
      const issues=[];
      const b = money(base && base.value), f = money(final && final.value), q = parseInt(qty && qty.value || '0',10)||0;
      if (!(isFinite(b) && isFinite(f) && f < b)) issues.push('–ù–æ–≤–∞—è —Ü–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–Ω—å—à–µ –æ–±—ã—á–Ω–æ–π.');
      if (!(q>0)) issues.push('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0.');
      const now = new Date();
      const exDt = parseDate(ex && ex.value);
      if (!exDt || exDt <= now) issues.push('–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –æ—Ñ—Ñ–µ—Ä–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –±—É–¥—É—â–µ–º.');
      const bbDt = parseDate(bb && bb.value);
      if (exDt && bbDt && exDt > bbDt) issues.push('¬´–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –æ—Ñ—Ñ–µ—Ä–∞¬ª –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∂–µ ¬´–°—Ä–æ–∫–∞ –≥–æ–¥–Ω–æ—Å—Ç–∏¬ª.');
      const desc = form.querySelector('textarea[name="description"]');
      if (desc && desc.value && desc.value.length > 160) issues.push('–û–ø–∏—Å–∞–Ω–∏–µ: –º–∞–∫—Å–∏–º—É–º 160 —Å–∏–º–≤–æ–ª–æ–≤.');
      if (issues.length){
        e.preventDefault();
        if (err){ err.textContent = issues[0]; err.classList.remove('hidden'); }
      }
    });
  }
})();
</script>


</body>
</html>
